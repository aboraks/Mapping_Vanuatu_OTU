---
title: "Untitled"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Take care of some housekeeping 
```{r}
# following this site
rm(list=ls())
dir.create(file.path("./", "Generated.Results"), showWarnings = FALSE)
```
Install some packages:
```{r}
library("phyloseq")
library("vegan")
library("ggplot2")
#library("tidyr")
library("dplyr")
#library("automap")
#library("mltools")
```
The working directory is set within this RMD package, 
But we're still going to need some data to work with
For now this is stored on a local repository 
In the future link this to a figshare DOI
```{r}
#set WD
setwd("/Users/fungi/Google Drive/Projects/Vanuatu/Vanuatu Molecular/New_Analysis/R")

# load data
# a transformed phyloseq object 
vst_physeq <- readRDS(file = "vst_physeq_geog.rds")
```

Remove OTUs that do not show appear more than 0 times in more than half the samples
```{r}
sbst <- subset_samples(vst_physeq, Sample_Type == c("Understory","Ground"))
    count_tab <-  otu_table(sbst) #this is an OTU table with abundences for the OTUs subsetted above 
    count_tab[count_tab <= 0.0] <- 0.0 # since this is a VST transeformed dataset, we'll need to set negative values to zero

    count_tab <- count_tab[rowSums(count_tab)>1,]
    
     otu_table(sbst) <- count_tab # and reinsert into the phylloseq object 
 sample_sums(sbst)[1:10] # double check to make sure tha worked 
```
A quick name shuffle to make IDs more meaningfull 
```{r}
change_id <-  sample_data(sbst)
levels(change_id$Sample_Type)[match("Ground",levels(change_id$Sample_Type))] <- "Soil"
levels(change_id$Sample_Type)[match("Understory",levels(change_id$Sample_Type))] <- "Phyllosphere"
sample_data(sbst) <- change_id

```

```{r}
GP.ord <- ordinate(sbst, "NMDS", "bray")
```
Only if you're interested in plotting by transect also 
```{r}
class(sample_data(sbst)$Transect)
sample_data(sbst)$Transect <- as(sample_data(sbst)$Transect, "character")
```

```{r}
#Set colour palette
ground.und.colours <- c("#996600","#669900")
# change labels to more appropriate names 



p2 = plot_ordination(sbst, GP.ord,color="Sample_Type")#, shape = "Transect")
p2 + 
  #geom_polygon(aes(fill=Sample_Type)) + 
  geom_point() + 
  scale_colour_manual(values=ground.und.colours)+
  stat_ellipse() +
  xlab("NMDS - axis 1")+
  ylab("NMDS - axis 2")+
  theme(panel.background = element_rect(fill = "white", colour = "black"),
        strip.background = element_rect(fill = "white", colour = "black"),
        #legend.key = element_blank(),
        #legend.justification = c(1.1, 0),# x-axis 
        legend.position = c(0.79, 0.13),# x,y
        legend.title = element_blank(),
        legend.background = element_rect(fill = "lightgrey",
                                  size=0.2, linetype="solid",
                                  colour ="black"))

 #labs(title = "NMDS Plot")
```

Time for a PermANOVA (adonis)
```{r}
sbst_bray <- phyloseq::distance(sbst, method = "bray")
sampledf <- data.frame(sample_data(sbst))
adonis(sbst_bray ~ Sample_Type, data = sampledf)

```



And save it 
```{r}
ggsave( plot = last_plot(), filename = paste("./Generated.Results/NMDS_SoilPhyllosphere.pdf"), device = NULL, path = NULL,
        scale = 1, width = 88, height = 88, units = "mm", 
        dpi = 300, limitsize = TRUE)
```

