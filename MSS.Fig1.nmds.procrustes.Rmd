---
title: "Fig 1 NMDS procrusties per habitat"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Take care of some housekeeping 
```{r}
# following this site
rm(list=ls())
dir.create(file.path("./", "Generated.Results"), showWarnings = FALSE)
set.seed(1)
```
Install some packages:
```{r}
library("phyloseq")
library("vegan")
library("ggplot2")
#library("tidyr")
library("dplyr")
library("cowplot")
library("ggforce") #for venn diagram
#library("mltools")
```

The working directory is set within this RMD package, 
But we're still going to need some data to work with
For now this is stored on a local repository 
In the future link this to a figshare DOI
```{r}
# load data
# a transformed phyloseq object 
vst_physeq <- readRDS(file = "~/Google Drive/Projects/Vanuatu/Vanuatu Molecular/New_Analysis/R/vst_physeq_geog.rds")
```

Remove OTUs that do not show appear more than 0 times in more than half the samples
```{r}
sbst <- subset_samples(vst_physeq, Sample_Type == c("Understory","Ground"))
    count_tab <-  otu_table(sbst) #this is an OTU table with abundences for the OTUs subsetted above 
    count_tab[count_tab <= 0.0] <- 0.0 # since this is a VST transeformed dataset, we'll need to set negative values to zero

    count_tab <- count_tab[rowSums(count_tab)>1,]
   # count_tab <- decostand(count_tab, "hellinger")
    
    
     otu_table(sbst) <- count_tab # and reinsert into the phylloseq object 
 sample_sums(sbst)[1:10] # double check to make sure tha worked 
```
A quick name change to make IDs more meaningfull 
```{r}
change_id <-  sample_data(sbst)
levels(change_id$Sample_Type)[match("Ground",levels(change_id$Sample_Type))] <- "Soil"
levels(change_id$Sample_Type)[match("Understory",levels(change_id$Sample_Type))] <- "Phyllosphere"
sample_data(sbst) <- change_id

```

```{r}
GP.ord <- ordinate(sbst, "NMDS", "bray")
```
Only if you're interested in plotting by transect also 
```{r}
class(sample_data(sbst)$Transect)
sample_data(sbst)$Transect <- as(sample_data(sbst)$Transect, "character")
```

```{r}
#Set colour palette
ground.und.colours <- c("#996600","#669900")
# change labels to more appropriate names 



p2 = plot_ordination(sbst, GP.ord,color="Sample_Type", shape = "Sample_Type")
nmds <- p2 + 
  #geom_polygon(aes(fill=Sample_Type)) + 
  geom_point() + 
  scale_colour_manual(values=ground.und.colours)+
  stat_ellipse() +
  annotate("text", x=1.2, y=-2.1, label= "Phyllosphere", color="#669900",fontface="bold", size=4.0) +
  annotate("text", x=-2.0, y=-2.1, label= "Soil", color="#996600",fontface="bold", size=4.0) +
  annotate("text", x=1.3, y=2.4, label= "Stress = 0.163", size=4.0) +
  xlab("NMDS - axis 1")+
  ylab("NMDS - axis 2")+
  theme(panel.background = element_rect(fill = "white", colour = "black"),
        strip.background = element_rect(fill = "white", colour = "black"),
        legend.key = element_blank(),
        legend.position = "none",
        legend.title = element_blank())
        #text=element_text(size=rel(3.8)),
        #axis.text=element_text(size=rel(1.5)))

 #labs(title = "NMDS Plot")
```

Time for a PermANOVA (adonis)
```{r}
sbst_bray <- phyloseq::distance(sbst, method = "bray")
sampledf <- data.frame(sample_data(sbst))
adonis(sbst_bray ~ Sample_Type, data = sampledf)

```



And save it 
```{r}
ggsave( plot = last_plot(), filename = paste("./Generated.Results/NMDS_SoilPhyllosphere.pdf"), device = NULL, path = NULL,
        scale = 1, width = 88, height = 88, units = "mm", 
        dpi = 300, limitsize = TRUE)
```




Venn Diagram 
```{r}




df.venn <- data.frame(x = c(0, 0),
                      y = c(1.7, 0),
                      tx = c(0, 0),
                      ty = c(2, -1),
                      cat = c('A \n 12321', 'B'))

venn <- ggplot(df.venn, aes(x0 = x, y0 = y, r = 1.7, fill = cat)) +
    geom_circle(alpha = .3, size = 1, colour = 'grey', show.legend = FALSE) +
        #geom_text(aes(x =tx, y = ty, label = cat), size=7)+
        coord_fixed() +
        scale_fill_manual(values = c("#669900","#996600")) +
        labs(fill = NULL) +
        annotate(geom = "text", x =0, y = 2.3, label = "Phyllosphere specialists \n 2212", size = 4)+
        annotate(geom = "text", x =0, y = 0.8, label = "Generalists \n 1307", size = 4)+
        annotate(geom = "text", x =0, y = -0.8, label = "Soil specialists \n 2187", size = 4)+
          theme_void()
```

combine nmds and venn
```{r}
combo <- plot_grid(nmds,venn,
                   labels = c("a.", "b."))
```
and save
```{r}
save_plot(plot = combo, filename = paste("./Generated.Results/Fig1.nmds.pdf"),
          base_height = 3.71,
          base_asp = 1.618,
          base_width = NULL)
```

